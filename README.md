# companies-stream: Journalistic R tool utilising Companies House data

This package includes:

- Access to real-time updates from the UK Companies House streaming API
- Utility functions for parsing, analysis and visualisation
- A demo Shiny application

Some features are under development, please check rest of documentation for current functionality.

## Intoduction

Companies House release a number of <a href="https://www.gov.uk/guidance/companies-house-data-products">data products</a>, including the <a href="http://download.companieshouse.gov.uk/en_output.html">Company Data Product</a>, a downloadable CSV snapshot containing basic company data of live companies on the register. The Product is a great source for journalists, but as it gets updated every month it only lists data up to the last day of the previous month. In addition, the <a href="https://developer.companieshouse.gov.uk/api/docs/">main API</a> does return up-to-date records, but it is not designed to access bulk data.

The newer <a href="https://developer.companieshouse.gov.uk/developer/applications">Companies House streaming API</a> returns a live stream of update events, which can then be used by the journalist to update the CSV to the present day.

## How to stream

1. Set the working directory to the root of the project:
```
setwd("path/to/companies-stream")
```

2. To access the <a href="https://developer-specs.companieshouse.gov.uk/streaming-api/guides/overview">Companies House Streaming API</a>, first <a href="https://developer.companieshouse.gov.uk/api/docs/index/gettingStarted/quickStart.html#createaccount">set up</a> a user account, create a key in the <a href="https://developer.companieshouse.gov.uk/developer/applications">Developer Hub</a> and store it as an evironment variable named <code>CH_STREAMING_API_KEY</code>. To do so via R, run:

```
Sys.setenv(CH_STREAMING_API_KEY = "your_api_key_here")
```

3. Each event returned by the ```/companies``` endpoint is assigned a timepoint, which is then incremented by one for the next event. To get an idea of where the current timepoint values are, run on a terminal
```
curl -XGET -H "Authorization: your_api_key_here" https://stream.companieshouse.gov.uk/companies
```
and note down the timepoint value of an event.

4. In the ```streaming/streaming_script.R```, change the timepoint value to a lower value than the current timepoint. Due to the huge amount of events, the API can only go back a few days. Set the timeout and run the first line. The response is stored in a new file in the data folder.

At the moment this process is manual and assumes trial attempts to find the right request parameters. In a newsroom setting, the command could be run by a daily cron job, which would automatically store the last timepoint.


5. To parse the stored <a href="http://ndjson.org/">ndjson</a> events and transform them into a data frame for subsequent analyses, run the second command.

Parsing will fail if streaming was cut prematurely and an event transmission was not completed. Further work needs to be done to ensure resillience.

## Data processing

The folder ```/processing``` contains functions for analysis and visualisation of company data. The ```company_data_product_script_generic.R``` demonstrates how to manipulate and compare data sourced from the stream and CSV, or from the CSV alone.

## Demo

A demo shiny application that uses the visualisations generated by the ```company_data_product_script.R``` can be found in ```/demo```.


